{
  "info": {
    "name": "WokiBrain API - Step by Step Guide",
    "description": "Gu√≠a paso a paso para probar la API de WokiBrain.\n\n## Instrucciones\n\n1. **Paso 1: Setup Inicial** - Verificar que la API est√© funcionando y configurar datos de prueba\n2. **Paso 2: Discovery** - Buscar mesas disponibles para una fecha y hora\n3. **Paso 3: Booking** - Crear una reserva\n4. **Paso 4: Verification** - Verificar que la reserva se cre√≥ correctamente\n5. **Paso 5: Advanced** - Casos avanzados y validaciones\n\n## Configuraci√≥n\n\n- **Local**: http://localhost:3000/api/v1\n- **Production**: https://wokibrain.grgcrew.com/api/v1\n\nSelecciona el environment correspondiente en Postman.",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "_exporter_id": "1"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3000/api/v1",
      "type": "string"
    },
    {
      "key": "restaurant_id",
      "value": "R1",
      "type": "string"
    },
    {
      "key": "sector_id",
      "value": "S1",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "Paso 1: Setup Inicial",
      "description": "Verificar que la API est√© funcionando y configurar datos de prueba",
      "item": [
        {
          "name": "1.1 Health Check",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/health",
              "host": ["{{base_url}}"],
              "path": ["health"]
            },
            "description": "Verificar que la API est√© funcionando correctamente"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ API est√° funcionando', function () {",
                  "    pm.response.to.have.status(200);",
                  "    const jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.eql('ok');",
                  "    console.log('‚úÖ API est√° funcionando correctamente');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "1.2 Seed Database (Configurar datos de prueba)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "X-Admin-Secret",
                "value": "{{admin_secret}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/admin/seed",
              "host": ["{{base_url}}"],
              "path": ["admin", "seed"]
            },
            "description": "Este endpoint crea autom√°ticamente:\n- Restaurant R1\n- Sector S1\n- Tablas T1, T2, T3, T4, T5\n\n**IMPORTANTE**: Ejecuta este paso primero para tener datos de prueba."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Base de datos configurada', function () {",
                  "    pm.response.to.have.status(200);",
                  "    const jsonData = pm.response.json();",
                  "    ",
                  "    // Guardar IDs para usar en siguientes pasos",
                  "    if (jsonData.data) {",
                  "        pm.collectionVariables.set('restaurant_id', jsonData.data.restaurantId);",
                  "        pm.collectionVariables.set('sector_id', jsonData.data.sectorId);",
                  "        console.log('‚úÖ Datos configurados:');",
                  "        console.log('   Restaurant ID:', jsonData.data.restaurantId);",
                  "        console.log('   Sector ID:', jsonData.data.sectorId);",
                  "        console.log('   Tablas:', jsonData.data.tableIds.join(', '));",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Paso 2: Discovery (Buscar mesas disponibles)",
      "description": "Buscar mesas disponibles para una fecha, hora y n√∫mero de personas",
      "item": [
        {
          "name": "2.1 Buscar mesas disponibles",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/woki/discover?restaurantId={{restaurant_id}}&sectorId={{sector_id}}&date=2025-10-22&partySize=4&duration=90&windowStart=20:00&windowEnd=23:45",
              "host": ["{{base_url}}"],
              "path": ["woki", "discover"],
              "query": [
                {
                  "key": "restaurantId",
                  "value": "{{restaurant_id}}",
                  "description": "ID del restaurante (R1 despu√©s del seed)"
                },
                {
                  "key": "sectorId",
                  "value": "{{sector_id}}",
                  "description": "ID del sector (S1 despu√©s del seed)"
                },
                {
                  "key": "date",
                  "value": "2025-10-22",
                  "description": "Fecha en formato YYYY-MM-DD"
                },
                {
                  "key": "partySize",
                  "value": "4",
                  "description": "N√∫mero de personas"
                },
                {
                  "key": "duration",
                  "value": "90",
                  "description": "Duraci√≥n en minutos (60, 90, o 120)"
                },
                {
                  "key": "windowStart",
                  "value": "20:00",
                  "description": "Hora de inicio deseada (HH:MM)"
                },
                {
                  "key": "windowEnd",
                  "value": "23:45",
                  "description": "Hora de fin deseada (HH:MM)"
                }
              ]
            },
            "description": "Busca mesas disponibles para:\n- 4 personas\n- 90 minutos de duraci√≥n\n- Entre las 20:00 y 23:45\n- El 22 de octubre de 2025"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Respuesta v√°lida', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 409]);",
                  "});",
                  "",
                  "if (pm.response.code === 200) {",
                  "    const jsonData = pm.response.json();",
                  "    ",
                  "    pm.test('‚úÖ Hay candidatos disponibles', function () {",
                  "        pm.expect(jsonData).to.have.property('candidates');",
                  "        pm.expect(jsonData.candidates).to.be.an('array');",
                  "    });",
                  "    ",
                  "    if (jsonData.candidates && jsonData.candidates.length > 0) {",
                  "        console.log('‚úÖ Encontradas', jsonData.candidates.length, 'opciones disponibles');",
                  "        console.log('   Primera opci√≥n:', jsonData.candidates[0]);",
                  "        ",
                  "        // Guardar primera opci√≥n para usar en el siguiente paso",
                  "        pm.collectionVariables.set('best_candidate_start', jsonData.candidates[0].start);",
                  "        pm.collectionVariables.set('best_candidate_end', jsonData.candidates[0].end);",
                  "    } else {",
                  "        console.log('‚ö†Ô∏è No hay mesas disponibles en ese horario');",
                  "    }",
                  "} else if (pm.response.code === 409) {",
                  "    console.log('‚ö†Ô∏è No hay capacidad disponible (409)');",
                  "}"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Paso 3: Booking (Crear reserva)",
      "description": "Crear una reserva usando los datos del paso anterior",
      "item": [
        {
          "name": "3.1 Crear reserva",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Generar una clave √∫nica para idempotencia",
                  "pm.collectionVariables.set('idempotency_key', pm.variables.replaceIn('{{$guid}}'));",
                  "console.log('üîë Idempotency Key:', pm.collectionVariables.get('idempotency_key'));"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Reserva creada o conflicto', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([201, 409]);",
                  "});",
                  "",
                  "if (pm.response.code === 201) {",
                  "    const jsonData = pm.response.json();",
                  "    ",
                  "    pm.test('‚úÖ Reserva creada correctamente', function () {",
                  "        pm.expect(jsonData).to.have.property('id');",
                  "        pm.expect(jsonData).to.have.property('status');",
                  "        pm.expect(jsonData.status).to.eql('CONFIRMED');",
                  "    });",
                  "    ",
                  "    // Guardar ID de la reserva para siguientes pasos",
                  "    pm.collectionVariables.set('booking_id', jsonData.id);",
                  "    ",
                  "    console.log('‚úÖ Reserva creada exitosamente');",
                  "    console.log('   ID:', jsonData.id);",
                  "    console.log('   Estado:', jsonData.status);",
                  "    console.log('   Mesas:', jsonData.tableIds.join(', '));",
                  "    console.log('   Inicio:', jsonData.start);",
                  "    console.log('   Fin:', jsonData.end);",
                  "} else if (pm.response.code === 409) {",
                  "    console.log('‚ö†Ô∏è Conflicto: No hay capacidad disponible o ya existe una reserva');",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idempotency_key}}",
                "type": "text",
                "description": "Clave √∫nica para evitar duplicados si se env√≠a la misma petici√≥n dos veces"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"restaurantId\": \"{{restaurant_id}}\",\n  \"sectorId\": \"{{sector_id}}\",\n  \"partySize\": 4,\n  \"durationMinutes\": 90,\n  \"date\": \"2025-10-22\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/woki/bookings",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings"]
            },
            "description": "Crea una reserva para:\n- 4 personas\n- 90 minutos de duraci√≥n\n- El 22 de octubre de 2025\n\nEl sistema autom√°ticamente selecciona la mejor mesa disponible."
          }
        },
        {
          "name": "3.2 Probar idempotencia (misma clave dos veces)",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "// Usar la misma clave de idempotencia del paso anterior",
                  "console.log('üîë Reutilizando Idempotency Key:', pm.collectionVariables.get('idempotency_key'));",
                  "console.log('   Esto deber√≠a devolver la misma reserva sin crear una nueva');"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Idempotencia funcionando', function () {",
                  "    const jsonData = pm.response.json();",
                  "    const originalId = pm.collectionVariables.get('booking_id');",
                  "    ",
                  "    if (originalId && jsonData.id) {",
                  "        pm.expect(jsonData.id).to.eql(originalId);",
                  "        console.log('‚úÖ Idempotencia correcta: Se devolvi√≥ la misma reserva');",
                  "        console.log('   ID original:', originalId);",
                  "        console.log('   ID recibido:', jsonData.id);",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{idempotency_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"restaurantId\": \"{{restaurant_id}}\",\n  \"sectorId\": \"{{sector_id}}\",\n  \"partySize\": 4,\n  \"durationMinutes\": 90,\n  \"date\": \"2025-10-22\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/woki/bookings",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings"]
            },
            "description": "Prueba la idempotencia: si env√≠as la misma petici√≥n dos veces con la misma Idempotency-Key, deber√≠as recibir la misma reserva sin crear una duplicada."
          }
        }
      ]
    },
    {
      "name": "Paso 4: Verification (Verificar reserva)",
      "description": "Verificar que la reserva se cre√≥ correctamente",
      "item": [
        {
          "name": "4.1 Obtener reserva por ID",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/woki/bookings/{{booking_id}}",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings", "{{booking_id}}"]
            },
            "description": "Obtiene los detalles de la reserva creada en el paso anterior"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Reserva encontrada', function () {",
                  "    pm.response.to.have.status(200);",
                  "    const jsonData = pm.response.json();",
                  "    ",
                  "    pm.expect(jsonData).to.have.property('id');",
                  "    pm.expect(jsonData).to.have.property('restaurantId');",
                  "    pm.expect(jsonData).to.have.property('sectorId');",
                  "    pm.expect(jsonData).to.have.property('tableIds');",
                  "    pm.expect(jsonData).to.have.property('status');",
                  "    ",
                  "    console.log('‚úÖ Reserva verificada:');",
                  "    console.log('   ID:', jsonData.id);",
                  "    console.log('   Estado:', jsonData.status);",
                  "    console.log('   Personas:', jsonData.partySize);",
                  "    console.log('   Duraci√≥n:', jsonData.durationMinutes, 'minutos');",
                  "    console.log('   Inicio:', jsonData.start);",
                  "    console.log('   Fin:', jsonData.end);",
                  "    console.log('   Mesas:', jsonData.tableIds.join(', '));",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "4.2 Listar todas las reservas de una fecha",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/woki/bookings?restaurantId={{restaurant_id}}&sectorId={{sector_id}}&date=2025-10-22",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings"],
              "query": [
                {
                  "key": "restaurantId",
                  "value": "{{restaurant_id}}"
                },
                {
                  "key": "sectorId",
                  "value": "{{sector_id}}"
                },
                {
                  "key": "date",
                  "value": "2025-10-22"
                }
              ]
            },
            "description": "Lista todas las reservas para un restaurante, sector y fecha espec√≠ficos"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Lista de reservas obtenida', function () {",
                  "    pm.response.to.have.status(200);",
                  "    const jsonData = pm.response.json();",
                  "    ",
                  "    pm.expect(jsonData).to.have.property('date');",
                  "    pm.expect(jsonData).to.have.property('bookings');",
                  "    pm.expect(jsonData.bookings).to.be.an('array');",
                  "    ",
                  "    console.log('‚úÖ Reservas encontradas:', jsonData.bookings.length);",
                  "    console.log('   Fecha:', jsonData.date);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "4.3 Cancelar reserva",
          "request": {
            "method": "DELETE",
            "header": [
              {
                "key": "Idempotency-Key",
                "value": "{{$guid}}",
                "type": "text"
              }
            ],
            "url": {
              "raw": "{{base_url}}/woki/bookings/{{booking_id}}",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings", "{{booking_id}}"]
            },
            "description": "Cancela la reserva creada anteriormente"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Reserva cancelada', function () {",
                  "    pm.expect(pm.response.code).to.be.oneOf([204, 404]);",
                  "    ",
                  "    if (pm.response.code === 204) {",
                  "        console.log('‚úÖ Reserva cancelada exitosamente');",
                  "    } else {",
                  "        console.log('‚ö†Ô∏è Reserva no encontrada (puede que ya est√© cancelada)');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Paso 5: Advanced (Casos avanzados)",
      "description": "Casos avanzados y validaciones",
      "item": [
        {
          "name": "5.1 Crear reserva con informaci√≥n del hu√©sped",
          "event": [
            {
              "listen": "prerequest",
              "script": {
                "exec": [
                  "pm.collectionVariables.set('guest_idempotency_key', pm.variables.replaceIn('{{$guid}}'));"
                ]
              }
            },
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    const jsonData = pm.response.json();",
                  "    console.log('‚úÖ Reserva creada con informaci√≥n del hu√©sped');",
                  "    console.log('   ID:', jsonData.id);",
                  "}"
                ]
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Idempotency-Key",
                "value": "{{guest_idempotency_key}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"restaurantId\": \"{{restaurant_id}}\",\n  \"sectorId\": \"{{sector_id}}\",\n  \"partySize\": 6,\n  \"durationMinutes\": 120,\n  \"date\": \"2025-10-22\",\n  \"guestName\": \"Juan P√©rez\",\n  \"guestEmail\": \"juan.perez@example.com\",\n  \"guestPhone\": \"+5491112345678\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/woki/bookings",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings"]
            },
            "description": "Crea una reserva incluyendo informaci√≥n del hu√©sped (nombre, email, tel√©fono)"
          }
        },
        {
          "name": "5.2 Buscar mesas para grupo grande (requiere combos)",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{base_url}}/woki/discover?restaurantId={{restaurant_id}}&sectorId={{sector_id}}&date=2025-10-22&partySize=8&duration=120",
              "host": ["{{base_url}}"],
              "path": ["woki", "discover"],
              "query": [
                {
                  "key": "restaurantId",
                  "value": "{{restaurant_id}}"
                },
                {
                  "key": "sectorId",
                  "value": "{{sector_id}}"
                },
                {
                  "key": "date",
                  "value": "2025-10-22"
                },
                {
                  "key": "partySize",
                  "value": "8"
                },
                {
                  "key": "duration",
                  "value": "120"
                }
              ]
            },
            "description": "Busca mesas para un grupo grande (8 personas). El sistema puede combinar varias mesas si es necesario."
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    const jsonData = pm.response.json();",
                  "    const comboCandidates = jsonData.candidates.filter(c => c.kind === 'combo');",
                  "    ",
                  "    if (comboCandidates.length > 0) {",
                  "        console.log('‚úÖ Se encontraron opciones combinando mesas');",
                  "        console.log('   Combos disponibles:', comboCandidates.length);",
                  "    }",
                  "}"
                ]
              }
            }
          ]
        },
        {
          "name": "5.3 Validaci√≥n: Tama√±o de grupo inv√°lido (negativo)",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"restaurantId\": \"{{restaurant_id}}\",\n  \"sectorId\": \"{{sector_id}}\",\n  \"partySize\": -5,\n  \"durationMinutes\": 90,\n  \"date\": \"2025-10-22\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/woki/bookings",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings"]
            },
            "description": "Prueba de validaci√≥n: el sistema debe rechazar un tama√±o de grupo negativo"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Validaci√≥n funcionando (debe rechazar)', function () {",
                  "    pm.response.to.have.status(400);",
                  "    console.log('‚úÖ El sistema rechaz√≥ correctamente el tama√±o de grupo inv√°lido');",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "5.4 Validaci√≥n: Duraci√≥n no m√∫ltiplo de 15",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"restaurantId\": \"{{restaurant_id}}\",\n  \"sectorId\": \"{{sector_id}}\",\n  \"partySize\": 4,\n  \"durationMinutes\": 85,\n  \"date\": \"2025-10-22\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/woki/bookings",
              "host": ["{{base_url}}"],
              "path": ["woki", "bookings"]
            },
            "description": "Prueba de validaci√≥n: la duraci√≥n debe ser m√∫ltiplo de 15 minutos (60, 75, 90, 105, 120, etc.)"
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('‚úÖ Validaci√≥n funcionando (debe rechazar)', function () {",
                  "    pm.response.to.have.status(400);",
                  "    console.log('‚úÖ El sistema rechaz√≥ correctamente la duraci√≥n inv√°lida');",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}
